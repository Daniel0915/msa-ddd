# 프로젝트 아키텍처 종합 가이드

## 1. 전체 아키텍처 개요

이 프로젝트는 **DDD (Domain-Driven Design)** 기반의 Spring Boot 애플리케이션으로, 향후 **MSA (Microservice Architecture)** 로 전환을 고려한 모놀리식 구조이다.

---

## 2. 기술 스택

| 구성요소 | 기술 | 버전 |
|---------|------|------|
| 프레임워크 | Spring Boot | 4.0.2 |
| 언어 | Java | 25 |
| ORM | Spring Data JPA (Hibernate) | - |
| DB | PostgreSQL (Docker) / H2 (개발) | 16 |
| 빌드 | Gradle Kotlin DSL | - |
| 코드 생성 | Lombok | - |
| 유효성 검사 | Jakarta Bean Validation | - |
| 배치 | Spring Batch | - |
| 컨테이너 | Docker Compose | - |

---

## 3. 패키지 구조

```
src/main/java/com/back/
│
├── MsaDddApplication.java          ← 진입점
│
├── boundedContext/                   ← ① 바운디드 컨텍스트
│   └── member/
│       ├── app/                     ← Application Layer
│       │   ├── MemberFacade.java          (오케스트레이터)
│       │   ├── MemberJoinCase.java        (가입 유스케이스)
│       │   ├── MemberSupport.java         (조회 전담)
│       │   └── MemberGetRandomSecureTipUseCase.java
│       ├── domain/                  ← Domain Layer
│       │   ├── Member.java                (엔티티/Aggregate Root)
│       │   ├── SourceMember.java          (확장 포인트)
│       │   └── MemberPolicy.java          (도메인 정책)
│       └── out/                     ← Infrastructure Layer
│           └── MemberRepository.java      (영속성)
│
├── shared/                          ← ② 공유 계층
│   └── member/
│       ├── domain/
│       │   └── BaseMember.java            (공통 필드)
│       ├── dto/
│       │   └── MemberDto.java             (데이터 전송 객체)
│       └── event/
│           ├── MemberJoinedEvent.java     (가입 이벤트)
│           └── MemberModifiedEvent.java   (수정 이벤트)
│
├── global/                          ← ③ 전역 인프라
│   ├── jpa/entity/
│   │   ├── BaseEntity.java               (최상위 엔티티)
│   │   └── HasModelTypeCode.java          (타입 식별 인터페이스)
│   ├── eventPublisher/
│   │   └── EventPublisher.java            (이벤트 발행기)
│   ├── excepton/
│   │   └── DomainException.java           (도메인 예외)
│   ├── reData/
│   │   └── RsData.java                   (표준 응답 래퍼)
│   └── global/
│       └── GlobalConfig.java              (전역 설정)
│
└── standard/                        ← ④ 표준/공통 인터페이스
    └── resultType/
        └── ResultType.java                (응답 타입 인터페이스)
```

---

## 4. 레이어별 역할

### ① boundedContext - 바운디드 컨텍스트

독립적인 비즈니스 도메인 단위이다. 각 컨텍스트는 자체적인 app/domain/out 계층을 가진다.

```
boundedContext/
├── member/        ← 회원 컨텍스트 (현재 구현)
├── post/          ← 게시글 컨텍스트 (DDL 준비됨)
├── cash/          ← 캐시/지갑 컨텍스트 (DDL 준비됨)
├── market/        ← 마켓 컨텍스트 (DDL 준비됨)
└── payout/        ← 정산 컨텍스트 (DDL 준비됨)
```

**MSA 전환 시:** 각 컨텍스트가 독립 서비스로 분리 가능

### ② shared - 공유 계층

바운디드 컨텍스트 간 공유가 필요한 **DTO와 이벤트**를 배치한다.

```
shared/member/
├── dto/MemberDto.java           ← 다른 컨텍스트가 회원 정보를 알아야 할 때
└── event/MemberJoinedEvent.java ← 다른 컨텍스트가 가입 사실을 알아야 할 때
```

### ③ global - 전역 인프라

모든 컨텍스트가 공통으로 사용하는 **기술 기반 코드**이다.

### ④ standard - 표준 인터페이스

프레임워크 수준의 **공통 계약(인터페이스)**이다.

---

## 5. 엔티티 상속 계층

```
BaseEntity (global)              ← 최상위: getId(), publishEvent()
    │
    └── BaseMember (shared)      ← 공통 필드: username, password, nickname
            │
            └── SourceMember (boundedContext)  ← JPA 설정: @Id, @CreatedDate
                    │
                    └── Member (boundedContext)  ← 실제 엔티티: @Entity, 비즈니스 메서드
```

| 계층 | 위치 | 역할 |
|------|------|------|
| `BaseEntity` | global | 모든 엔티티의 공통 기능 (이벤트 발행, 타입코드) |
| `BaseMember` | shared | 여러 컨텍스트가 공유하는 회원 필드 |
| `SourceMember` | boundedContext | 특정 컨텍스트의 JPA 매핑 설정 |
| `Member` | boundedContext | 실제 DB 테이블과 비즈니스 로직 |

**모두 `@MappedSuperclass`** (Member만 `@Entity`) → 테이블은 `MEMBER_MEMBER` 하나만 생성

---

## 6. 서비스 계층 구조

```
[Controller] (향후 구현)
     │
     ↓
[Facade] ─── 외부 진입점, 트랜잭션 관리
     │
     ├── [~Case]     ─── 명령(Command): 상태 변경 비즈니스 로직
     ├── [~UseCase]  ─── 조회 + 비즈니스 규칙
     └── [~Support]  ─── 순수 조회 (CRUD)
           │
           ↓
     [Repository]  ─── 데이터 접근
           │
           ↓
     [Database]
```

### 실제 클래스 매핑

```
MemberFacade (Facade)
├── MemberJoinCase (Case)           → join()
├── MemberGetRandomSecureTipUseCase → getRandomSecureTip()
└── MemberSupport (Support)         → count(), findByUsername(), findById()
```

---

## 7. 이벤트 기반 컨텍스트 간 통신

```
[Member Context]
     │
     ├── MemberJoinCase.join()
     │       │
     │       └── publish(MemberJoinedEvent)
     │                    │
     │                    ├──→ [Post Context Listener]
     │                    ├──→ [Cash Context Listener]
     │                    └──→ [Market Context Listener]
     │
     └── Member.increaseActivityScore()
             │
             └── publish(MemberModifiedEvent)
                          │
                          └──→ [Other Context Listeners]
```

**핵심:** 컨텍스트 간 직접 호출 없이 **이벤트**로 느슨하게 결합

---

## 8. 데이터베이스 설계 (테이블 네이밍)

```
{컨텍스트}_{엔티티}

member_member          ← 회원 컨텍스트의 회원 테이블 (구현됨)
post_member            ← 게시글 컨텍스트의 회원 테이블 (DDL 준비)
post_post              ← 게시글 컨텍스트의 게시글 테이블
cash_member            ← 캐시 컨텍스트의 회원 테이블
cash_wallet            ← 캐시 컨텍스트의 지갑 테이블
market_member          ← 마켓 컨텍스트의 회원 테이블
market_product         ← 마켓 컨텍스트의 상품 테이블
```

**각 컨텍스트가 자체 회원 테이블을 가짐:**
- `member_member`: 원본 (Source of Truth)
- `post_member`: Post 컨텍스트에서 필요한 회원 정보만 복사
- 이벤트를 통해 데이터 동기화

---

## 9. 설정 관리

### application.yml 구조

```yaml
server:
  port: 8080

spring:
  jpa:
    hibernate:
      ddl-auto: update           # 엔티티 변경 시 테이블 자동 수정
    show-sql: true               # SQL 로그 출력
  batch:
    job:
      enabled: false             # 배치 자동 실행 비활성화

custom:                          # 커스텀 비즈니스 설정
  member:
    password:
      changeDays: 90             # → MemberPolicy에서 사용
```

### 커스텀 설정 → Domain Policy 연결

```
application.yml                     → @Value 주입          → MemberPolicy
custom.member.password.changeDays   → PASSWORD_CHANGE_DAYS → isNeedToChangePassword()
```

---

## 10. 문서 가이드 목록

| 문서 | 핵심 내용 |
|------|----------|
| `DDD-바운디드컨텍스트-가이드.md` | DDD 개념, 바운디드 컨텍스트, 프로젝트 구조 |
| `Spring-Event-Publisher-가이드.md` | ApplicationEventPublisher, @EventListener |
| `Spring-Data-JPA-가이드.md` | JPA 엔티티, 쿼리 메서드, 트랜잭션 |
| `MappedSuperclass-가이드.md` | @MappedSuperclass 상속, 4단계 계층 구조 |
| `Bean-Validation-가이드.md` | @Valid, 커스텀 Validator |
| `Spring-Boot-핵심-어노테이션-가이드.md` | @Service, @Repository, @Configuration 등 |
| `Lombok-가이드.md` | @Getter, @Builder, @RequiredArgsConstructor |
| `Docker-PostgreSQL-가이드.md` | Docker Compose, PostgreSQL 설정 |
| `Spring-Batch-가이드.md` | Job, Step, Chunk 기반 배치 |
| `Facade-패턴-가이드.md` | Facade 패턴, 단일 진입점, 트랜잭션 관리 |
| `UseCase-패턴-가이드.md` | UseCase/Case/Support 분리, CQRS |
| `커스텀-예외-및-응답-처리-가이드.md` | DomainException, RsData, ResultType |
| `Domain-Policy-가이드.md` | 도메인 정책, @Value 설정 주입 |
| `Domain-Event-실전-가이드.md` | 이벤트 설계, DTO vs Entity, 발행 방법 |
| `Gradle-Kotlin-DSL-가이드.md` | build.gradle.kts, 의존성 스코프 |
| `프로젝트-아키텍처-종합-가이드.md` | 전체 아키텍처 종합 정리 (본 문서) |

---

## 11. 향후 확장 방향

### 모놀리식 → MSA 전환 경로

```
현재: 모놀리식 (하나의 애플리케이션)
├── boundedContext/member/
├── boundedContext/post/       (예정)
└── boundedContext/cash/       (예정)

향후: MSA (독립 서비스)
├── member-service/            (독립 배포)
├── post-service/              (독립 배포)
└── cash-service/              (독립 배포)
```

**전환이 용이한 이유:**
1. 바운디드 컨텍스트가 이미 분리되어 있음
2. 이벤트 기반 통신 → 메시지 큐로 교체만 하면 됨
3. 각 컨텍스트가 자체 테이블을 가짐 → DB 분리 용이
4. shared 계층의 DTO/Event → API 계약으로 전환 가능

---

## 12. 핵심 정리

1. **DDD + Clean Architecture** 기반으로 도메인 중심 설계
2. **Facade → UseCase → Domain → Repository** 레이어 분리
3. **이벤트 기반** 컨텍스트 간 통신으로 느슨한 결합
4. **@MappedSuperclass** 상속 계층으로 코드 재사용
5. **커스텀 예외 + 표준 응답** 으로 일관된 API 설계
6. **MSA 전환을 고려한** 모놀리식 구조
